<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Trading UI</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        /* Custom styles to ensure edge-to-edge fit and smooth transitions */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Very light gray background */
            margin: 0;
            padding: 0;
            overscroll-behavior: contain; /* Prevent pull-to-refresh on scroll */
        }
        #app-container {
            max-width: 500px; /* Max width for mobile emulation */
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* Watchlist Header Animation */
        #watchlist-header {
            transition: transform 0.3s ease-in-out;
            will-change: transform;
            z-index: 20;
            position: sticky;
            top: 0;
        }

        /* Search Input Animation */
        #search-container {
            transition: all 0.3s ease-in-out;
        }
        .search-focused {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 500px;
            width: 100%;
            padding: 16px 20px;
            height: 100vh;
            background-color: white;
            z-index: 50;
        }

        /* Bottom Sheet (Stock Details Popup) Animation */
        #stock-detail-sheet {
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 60;
        }
        .sheet-open {
            transform: translateY(0%);
        }

        /* Index Popup Animation */
        #index-popup {
            transform: translateY(-100%);
            transition: transform 0.3s ease-out;
            z-index: 40;
        }
        .index-open {
            transform: translateY(0%);
        }

        /* Global Modal Overlay */
        #modal-overlay {
            z-index: 30;
            transition: opacity 0.3s ease;
        }

        /* Custom scrollbar for horizontal tabs */
        #watchlist-tabs::-webkit-scrollbar {
            display: none;
        }
        #watchlist-tabs {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* Custom swipe animation container */
        .watchlist-swipe-container {
            overflow-x: hidden;
            scroll-behavior: smooth;
        }
        .watchlist-page {
            flex-shrink: 0;
            width: 100%;
            padding-bottom: 80px; /* Space for the bottom nav */
        }

    </style>
</head>
<body class="selection:bg-gray-200">

<!-- The main mobile container -->
<div id="app-container" class="h-screen overflow-hidden">
    <!-- Overlay for Popups/Bottom Sheet -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none transition-opacity"></div>

    <!-- Watchlist Index Popup (Half-screen) -->
    <div id="index-popup" class="fixed top-0 left-0 w-full h-1/2 bg-white shadow-xl max-w-[500px] mx-auto overflow-hidden">
        <div class="p-4 border-b border-gray-100 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-black">Market Indices</h2>
            <i onclick="toggleIndexPopup()" class="fa-solid fa-xmark text-lg text-black cursor-pointer p-2"></i>
        </div>
        <div id="index-list" class="p-4 space-y-3 overflow-y-auto h-full pb-16">
            <!-- Index items will be rendered here -->
        </div>
    </div>

    <!-- GTT Fullscreen Order Window -->
    <div id="gtt-screen" class="fixed inset-0 bg-white z-70 transform translate-x-full transition-transform duration-300 max-w-[500px] mx-auto overflow-y-auto">
        <!-- GTT content will be rendered here when opened -->
    </div>

    <!-- Main Content Area -->
    <div id="main-content" class="flex-grow overflow-y-auto relative p-0">
        <!-- Watchlist Header (Sticky and Animating) -->
        <div id="watchlist-header" class="bg-white pt-4 px-4 pb-0 border-b border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-2">
                    <h1 class="text-xl font-bold text-black">Watchlist</h1>
                    <i id="index-toggle-icon" onclick="toggleIndexPopup()" class="fa-solid fa-chevron-down text-sm text-gray-500 cursor-pointer transition-transform duration-300"></i>
                </div>
                <div class="flex items-center space-x-4">
                    <i id="notification-icon" class="fa-solid fa-bell text-lg text-gray-700 cursor-pointer relative" onclick="openNotificationPopup()">
                        <span id="alert-dot" class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500 hidden"></span>
                    </i>
                </div>
            </div>
            <!-- Notification Popup (Arrow indicator) -->
            <div id="notification-popup" class="absolute right-4 top-14 mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-xl p-3 transform scale-0 origin-top-right transition-transform duration-200">
                <div class="absolute -top-2 right-3 w-0 h-0 border-l-8 border-l-transparent border-r-8 border-r-transparent border-b-8 border-b-white shadow-md"></div>
                <p id="alert-message" class="text-sm text-black">No active alerts.</p>
            </div>

            <!-- Watchlist Tabs (Horizontal Scroll) -->
            <div id="watchlist-tabs" class="flex overflow-x-scroll whitespace-nowrap space-x-6 pb-2">
                <!-- Tabs will be rendered here -->
            </div>
        </div>

        <!-- Search Input & Stock List -->
        <div id="search-container" class="px-4 py-3 bg-white">
            <div class="relative">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                <input id="search-input" type="text" placeholder="Search stocks, F&O, indices"
                       class="w-full bg-gray-100 text-black placeholder-gray-500 rounded-lg py-2 pl-10 pr-4 text-sm focus:outline-none focus:ring-0 focus:bg-white focus:shadow-md transition-all duration-300"
                       onfocus="handleSearchFocus()" onblur="handleSearchBlur()" oninput="handleSearchInput(this.value)">
            </div>
            <!-- Search Results/Autocomplete (Visible when focused) -->
            <div id="search-results" class="hidden mt-4 space-y-2">
                <!-- Autocomplete suggestions will appear here -->
            </div>
        </div>

        <!-- Main Stock List Container (Swipable) -->
        <div id="stock-list-container" class="watchlist-swipe-container flex">
            <!-- Watchlist pages will be rendered here -->
        </div>
    </div>

    <!-- Stock Detail Bottom Sheet Popup -->
    <div id="stock-detail-sheet" class="fixed bottom-0 left-0 w-full bg-white rounded-t-2xl shadow-2xl max-w-[500px] mx-auto overflow-hidden h-1/2 flex flex-col"
         ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
        <div class="p-4 flex flex-col">
            <div id="drag-handle" class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-3 cursor-grab"></div>

            <!-- Header Info -->
            <div id="sheet-header-info" class="flex justify-between items-start mb-4">
                <!-- Content will be injected here -->
            </div>

            <div class="w-full h-px bg-gray-200 mb-4"></div>

            <!-- Action Buttons: Buy/Sell -->
            <div class="flex space-x-3 mb-4">
                <button id="btn-buy" class="flex-1 py-3 text-white font-semibold rounded-lg text-sm transition-all duration-150 bg-green-600 active:bg-green-700">
                    BUY
                </button>
                <button id="btn-sell" class="flex-1 py-3 text-white font-semibold rounded-lg text-sm transition-all duration-150 bg-red-600 active:bg-red-700">
                    SELL
                </button>
            </div>

            <!-- Secondary Buttons -->
            <div class="grid grid-cols-3 gap-3 text-center mb-4 text-sm text-gray-700 font-medium">
                <button onclick="openAddNotePopup()" class="p-2 bg-gray-100 rounded-lg transition-colors active:bg-gray-200">
                    <i class="fa-solid fa-pencil text-xs mr-1"></i> Add Note
                </button>
                <button onclick="openGTTOrder()" class="p-2 bg-gray-100 rounded-lg transition-colors active:bg-gray-200">
                    <i class="fa-solid fa-cart-shopping text-xs mr-1"></i> Create GTT
                </button>
                <button onclick="openSetAlertPopup()" class="p-2 bg-gray-100 rounded-lg transition-colors active:bg-gray-200">
                    <i class="fa-solid fa-bell text-xs mr-1"></i> Set Alert
                </button>
            </div>

            <div class="w-full h-px bg-gray-200 mb-4"></div>

            <!-- Notes Section -->
            <div id="notes-list" class="overflow-y-auto space-y-2 h-20">
                <h3 class="text-sm font-semibold text-black mb-1">Notes:</h3>
                <!-- Notes will be injected here -->
                <p id="no-notes" class="text-xs text-gray-500 italic">No notes added for this stock.</p>
            </div>
        </div>
    </div>

    <!-- Universal Popup Containers (Modals for Notes and Alerts) -->
    <div id="notes-popup" class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none transition-opacity z-80 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm transform scale-90 transition-transform duration-200">
            <h2 class="text-lg font-semibold text-black mb-4">Add Note for <span id="note-stock-name" class="text-blue-600"></span></h2>
            <textarea id="note-content" rows="4" class="w-full border border-gray-300 rounded-md p-2 text-sm text-black focus:ring-0 focus:border-gray-500" placeholder="Type your note here..."></textarea>
            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="closeAddNotePopup()" class="px-4 py-2 text-sm text-gray-700 rounded-lg hover:bg-gray-100">Cancel</button>
                <button onclick="saveNote()" class="px-4 py-2 text-sm text-white rounded-lg bg-blue-600 active:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <div id="alert-popup" class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none transition-opacity z-80 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm transform scale-90 transition-transform duration-200">
            <h2 class="text-lg font-semibold text-black mb-4">Set Price Alert</h2>
            <p class="text-sm text-gray-700 mb-2">Current Price: <span id="alert-current-price" class="font-bold text-black"></span></p>
            <div class="mb-4">
                <label for="alert-price-input" class="block text-sm font-medium text-gray-700 mb-1">Trigger Price:</label>
                <input type="number" id="alert-price-input" class="w-full border border-gray-300 rounded-md p-2 text-sm text-black focus:ring-0 focus:border-gray-500" placeholder="Enter target price">
            </div>
            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="closeSetAlertPopup()" class="px-4 py-2 text-sm text-gray-700 rounded-lg hover:bg-gray-100">Cancel</button>
                <button onclick="saveAlert()" class="px-4 py-2 text-sm text-white rounded-lg bg-blue-600 active:bg-blue-700">Set Alert</button>
            </div>
        </div>
    </div>


    <!-- Bottom Navigation Bar (Fixed) -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 w-full border-t border-gray-200 bg-white max-w-[500px] mx-auto z-50">
        <div class="flex justify-around py-3 text-xs text-center">
            <div class="nav-item text-blue-600 flex flex-col items-center">
                <i class="fa-solid fa-list-ul text-xl mb-1"></i>
                <span class="text-xs">Watchlists</span>
            </div>
            <div class="nav-item text-gray-500 flex flex-col items-center">
                <i class="fa-solid fa-receipt text-xl mb-1"></i>
                <span class="text-xs">Orders</span>
            </div>
            <div class="nav-item text-gray-500 flex flex-col items-center">
                <i class="fa-solid fa-briefcase text-xl mb-1"></i>
                <span class="text-xs">Portfolio</span>
            </div>
            <div class="nav-item text-gray-500 flex flex-col items-center">
                <i class="fa-solid fa-book-open text-xl mb-1"></i>
                <span class="text-xs">Notes</span>
            </div>
            <div class="nav-item text-gray-500 flex flex-col items-center">
                <i class="fa-solid fa-user-circle text-xl mb-1"></i>
                <span class="text-xs">Profile</span>
            </div>
        </div>
    </nav>
</div>

<!-- Firebase and App Script -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GLOBAL STATE & FIREBASE SETUP ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    let db, auth;
    let userId = 'loading'; // Will be set after auth
    let currentWatchlistId = 'default';
    let currentWatchlistIndex = 0;
    let currentStock = null; // Stock object currently opened in bottom sheet

    let allWatchlists = []; // Array of { id, name }
    let watchlistStocks = {}; // Map: watchlistId -> Array of stocks
    let stockAlerts = {}; // Map: stockId -> Array of alerts
    let stockNotes = {}; // Map: stockId -> Array of notes

    // Mock/Dummy Data for Stock List
    const MOCK_STOCKS = [
        { id: 'tcs_eq', name: 'TCS', index: 'NSE', price: 3820.50, change: 45.20, percent: 1.20, holdings: 10 },
        { id: 'infy_eq', name: 'Infosys', index: 'NSE', price: 1540.75, change: -12.30, percent: -0.80, holdings: 50 },
        { id: 'reliance_eq', name: 'Reliance', index: 'NSE', price: 2950.10, change: 8.90, percent: 0.30, holdings: 20 },
        { id: 'hdfc_eq', name: 'HDFC Bank', index: 'BSE', price: 1720.00, change: -30.50, percent: -1.75, holdings: 0 },
        { id: 'maruti_f', name: 'MARUTI FEB FUT', index: 'NSE', price: 10200.00, change: 120.00, percent: 1.18, holdings: 0 },
        { id: 'sbin_c', name: 'SBIN 700 CE', index: 'NSE', price: 40.50, change: 10.50, percent: 35.00, holdings: 0 },
        { id: 'tata_motors_eq', name: 'Tata Motors', index: 'NSE', price: 950.00, change: 15.20, percent: 1.62, holdings: 30 },
        { id: 'icici_bank_eq', name: 'ICICI Bank', index: 'BSE', price: 1100.50, change: -5.50, percent: -0.50, holdings: 5 },
    ];

    // Mock Data for Indices Popup
    const MOCK_INDICES = [
        { name: 'SENSEX', price: 73000.50, change: 250.20, percent: 0.34 },
        { name: 'NIFTY BANK', price: 48000.10, change: -150.80, percent: -0.31 },
        { name: 'NIFTY 50', price: 22100.75, change: 85.00, percent: 0.38 },
        { name: 'NIFTY FIN', price: 21500.25, change: 40.50, percent: 0.19 },
    ];

    // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
    window.onload = async function() {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            // Render error or proceed with mock data only
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            // setLogLevel('debug'); // Optional: uncomment for verbose logging

            // Auth: Use custom token if available, otherwise sign in anonymously
            if (typeof __initial_auth_token !== 'undefined') {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            }

            // Once authentication is ready, set up listeners
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    startFirestoreListeners();
                } else {
                    // Fallback for unauthenticated user (shouldn't happen with the token)
                    userId = crypto.randomUUID();
                    startFirestoreListeners(); // Still try to listen, but data will be local/mocked if security rules prevent read
                }
            });

        } catch (error) {
            console.error("Firebase setup failed:", error);
            // Fallback: Proceed with only mock data and UI rendering
            userId = crypto.randomUUID();
            startMockListeners();
        }
        setupWatchlistScrollBehavior();
        renderIndicesPopup();
    };

    const getCollectionPath = (collectionName) => {
        return `artifacts/${appId}/users/${userId}/${collectionName}`;
    };

    const startFirestoreListeners = () => {
        // 1. Listen for Watchlist Names
        onSnapshot(collection(db, getCollectionPath('watchlists')), (snapshot) => {
            const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (list.length === 0) {
                // If no watchlists exist, create a default one
                addDoc(collection(db, getCollectionPath('watchlists')), {
                    name: 'My Watchlist',
                    stocks: MOCK_STOCKS.map(s => s.id), // Use mock stock IDs
                    order: 0
                });
                return;
            }
            allWatchlists = list.sort((a, b) => a.order - b.order);
            if (!currentWatchlistId || !allWatchlists.find(w => w.id === currentWatchlistId)) {
                currentWatchlistId = allWatchlists[0].id;
                currentWatchlistIndex = 0;
            }
            renderWatchlistTabs();
            renderStockList();
        }, (error) => console.error("Error fetching watchlists:", error));

        // 2. Listen for Alerts (simplified, stored in a single document per user)
        onSnapshot(doc(db, getCollectionPath('alerts'), 'user_alerts'), (docSnap) => {
            if (docSnap.exists()) {
                stockAlerts = docSnap.data().alerts || {};
            } else {
                stockAlerts = {};
            }
            checkActiveAlerts();
        }, (error) => console.error("Error fetching alerts:", error));

        // 3. Listen for Notes (simplified, stored in a single document per user)
        onSnapshot(doc(db, getCollectionPath('notes'), 'user_notes'), (docSnap) => {
            if (docSnap.exists()) {
                stockNotes = docSnap.data().notes || {};
            } else {
                stockNotes = {};
            }
            // Re-render notes if the bottom sheet is open
            if (currentStock) {
                renderNotesList(currentStock.id);
            }
        }, (error) => console.error("Error fetching notes:", error));
    };

    // Fallback for environment without Firebase or errors
    const startMockListeners = () => {
        console.warn("Using mock data due to Firebase setup issues.");
        allWatchlists = [
            { id: 'default', name: 'My Watchlist', stocks: MOCK_STOCKS.slice(0, 4).map(s => s.id), order: 0 },
            { id: 'tech', name: 'Tech', stocks: MOCK_STOCKS.slice(0, 2).map(s => s.id), order: 1 },
        ];
        currentWatchlistId = 'default';
        currentWatchlistIndex = 0;

        // Mock alerts and notes structure
        stockAlerts = { 'tcs_eq': [{ price: 3900, created: Date.now() }] };
        stockNotes = { 'infy_eq': [{ content: 'Buy if it dips below 1500.', created: Date.now() }] };

        renderWatchlistTabs();
        renderStockList();
        checkActiveAlerts();
    }

    // --- UI RENDERING FUNCTIONS ---

    const renderWatchlistTabs = () => {
        const tabsEl = document.getElementById('watchlist-tabs');
        tabsEl.innerHTML = '';
        allWatchlists.forEach((list, index) => {
            const isActive = list.id === currentWatchlistId;
            const tab = document.createElement('div');
            tab.className = `cursor-pointer pb-2 text-sm font-medium transition-colors ${isActive ? 'text-black' : 'text-gray-500'}`;
            tab.style.borderBottom = isActive ? '2px solid #3b82f6' : '2px solid transparent';
            tab.textContent = list.name;
            tab.dataset.id = list.id;
            tab.onclick = () => changeWatchlist(list.id, index);
            tab.oncontextmenu = tab.ontouchstart = (e) => handleEditWatchlistName(e, list.id);
            tabsEl.appendChild(tab);
        });

        // Add the '+' icon
        const addTab = document.createElement('div');
        addTab.className = 'cursor-pointer pb-2 text-gray-500 hover:text-black transition-colors';
        addTab.innerHTML = '<i class="fa-solid fa-plus text-lg"></i>';
        addTab.onclick = addNewWatchlist;
        tabsEl.appendChild(addTab);

        // Scroll the active tab into view
        const activeTabEl = tabsEl.querySelector(`[data-id="${currentWatchlistId}"]`);
        if (activeTabEl) {
             activeTabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    };

    const renderStockList = () => {
        const listContainer = document.getElementById('stock-list-container');
        listContainer.innerHTML = ''; // Clear existing pages

        allWatchlists.forEach((list, index) => {
            const watchlistPage = document.createElement('div');
            watchlistPage.className = 'watchlist-page';
            watchlistPage.dataset.watchlistId = list.id;

            // Get stocks for the current list (using MOCK data for content display)
            const currentStockIds = list.stocks || [];
            const stocksToShow = MOCK_STOCKS.filter(s => currentStockIds.includes(s.id));

            if (stocksToShow.length === 0) {
                watchlistPage.innerHTML = `<p class="p-4 text-gray-500 text-sm italic">Add stocks using the search bar above.</p>`;
            } else {
                let html = stocksToShow.map(stock => {
                    const isPositive = stock.change >= 0;
                    const changeColor = isPositive ? 'text-green-600' : 'text-red-600';
                    const changeIcon = isPositive ? 'fa-caret-up' : 'fa-caret-down';
                    const holdingText = stock.holdings > 0 ? `<span class="text-xs text-gray-500 ml-1">(${stock.holdings})</span>` : '';

                    return `
                        <div class="px-4 py-3 flex justify-between items-center cursor-pointer active:bg-gray-50" onclick="handleStockClick('${stock.id}')" data-stock-id="${stock.id}">
                            <!-- Left Aligned Info -->
                            <div>
                                <p class="text-sm font-semibold text-black">${stock.name}</p>
                                <p class="text-xs text-gray-500 mt-0.5 uppercase">${stock.index} ${holdingText}</p>
                            </div>
                            <!-- Right Aligned Info -->
                            <div class="text-right">
                                <p class="text-sm font-semibold text-black">${stock.price.toFixed(2)}</p>
                                <p class="text-xs ${changeColor} mt-0.5">
                                    <i class="fa-solid ${changeIcon} mr-0.5"></i> ${Math.abs(stock.change).toFixed(2)} (${Math.abs(stock.percent).toFixed(2)}%)
                                </p>
                            </div>
                        </div>
                        <div class="h-px bg-gray-100 mx-4"></div>
                    `;
                }).join('');
                watchlistPage.innerHTML = html;
            }

            listContainer.appendChild(watchlistPage);
        });

        // Set the initial scroll position to the current watchlist
        listContainer.scrollLeft = currentWatchlistIndex * listContainer.offsetWidth;
    };

    const renderIndicesPopup = () => {
        const indexListEl = document.getElementById('index-list');
        indexListEl.innerHTML = MOCK_INDICES.map(index => {
            const isPositive = index.change >= 0;
            const changeColor = isPositive ? 'text-green-600' : 'text-red-600';
            const changeIcon = isPositive ? 'fa-caret-up' : 'fa-caret-down';

            return `
                <div class="flex justify-between items-center p-3 border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-sm font-semibold text-black">${index.name}</p>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-black">${index.price.toFixed(2)}</p>
                        <p class="text-xs ${changeColor} mt-0.5">
                            <i class="fa-solid ${changeIcon} mr-0.5"></i> ${Math.abs(index.change).toFixed(2)} (${Math.abs(index.percent).toFixed(2)}%)
                        </p>
                    </div>
                </div>
            `;
        }).join('');
    };

    const renderNotesList = (stockId) => {
        const notesListEl = document.getElementById('notes-list');
        notesListEl.querySelector('#no-notes').classList.add('hidden');
        // Clear previous notes, but keep the header
        notesListEl.querySelectorAll('.stock-note').forEach(el => el.remove());

        const notes = stockNotes[stockId] || [];

        if (notes.length === 0) {
            notesListEl.querySelector('#no-notes').classList.remove('hidden');
            return;
        }

        notes.forEach(note => {
            const noteEl = document.createElement('p');
            noteEl.className = 'stock-note text-xs text-black bg-gray-50 p-2 rounded-md border-l-2 border-blue-400';
            const date = new Date(note.created).toLocaleDateString();
            noteEl.innerHTML = `<span class="font-medium">${date}:</span> ${note.content}`;
            notesListEl.appendChild(noteEl);
        });
    };

    // --- INTERACTION HANDLERS ---

    // 1. Header Scroll Hide/Show
    let lastScrollTop = 0;
    const watchlistHeader = document.getElementById('watchlist-header');
    const mainContent = document.getElementById('main-content');

    const setupWatchlistScrollBehavior = () => {
        mainContent.addEventListener('scroll', () => {
            const scrollTop = mainContent.scrollTop;

            if (scrollTop > lastScrollTop) {
                // Scrolling down - Hide the header and search
                watchlistHeader.style.transform = 'translateY(-100%)';
            } else if (scrollTop < lastScrollTop) {
                // Scrolling up - Show the header and search
                watchlistHeader.style.transform = 'translateY(0)';
            }
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; // For Mobile or touch devices
        });
    }

    // 2. Index Popup (Down Arrow)
    const toggleIndexPopup = () => {
        const popup = document.getElementById('index-popup');
        const overlay = document.getElementById('modal-overlay');
        const toggleIcon = document.getElementById('index-toggle-icon');

        const isOpen = popup.classList.toggle('index-open');

        if (isOpen) {
            overlay.classList.remove('pointer-events-none', 'opacity-0');
            overlay.classList.add('pointer-events-auto', 'opacity-100');
            overlay.onclick = toggleIndexPopup;
            toggleIcon.classList.replace('fa-chevron-down', 'fa-xmark');
            toggleIcon.classList.add('text-black');
        } else {
            overlay.classList.remove('pointer-events-auto', 'opacity-100');
            overlay.classList.add('pointer-events-none', 'opacity-0');
            overlay.onclick = null;
            toggleIcon.classList.replace('fa-xmark', 'fa-chevron-down');
            toggleIcon.classList.remove('text-black');
        }
    };

    // 3. Watchlist Management
    const changeWatchlist = (id, index) => {
        currentWatchlistId = id;
        currentWatchlistIndex = index;
        renderWatchlistTabs();
        document.getElementById('stock-list-container').scrollLeft = index * document.getElementById('stock-list-container').offsetWidth;
        // No need to call renderStockList again, as the list container is just scrolled
    };

    const handleEditWatchlistName = async (e, id) => {
        e.preventDefault();
        const list = allWatchlists.find(w => w.id === id);
        if (!list) return;

        const newName = prompt(`Enter new name for: ${list.name}`);
        if (newName && newName.trim()) {
             try {
                // Update Firestore
                await setDoc(doc(db, getCollectionPath('watchlists'), id), { name: newName.trim() }, { merge: true });
            } catch (error) {
                console.error("Error updating watchlist name:", error);
            }
        }
    };

    const addNewWatchlist = async () => {
        const name = prompt("Enter new watchlist name:");
        if (name && name.trim()) {
            try {
                await addDoc(collection(db, getCollectionPath('watchlists')), {
                    name: name.trim(),
                    stocks: [],
                    order: allWatchlists.length
                });
            } catch (error) {
                console.error("Error adding new watchlist:", error);
            }
        }
    };

    // 4. Search Functionality
    const handleSearchFocus = () => {
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('search-input');
        searchContainer.classList.add('search-focused');
        document.getElementById('search-results').classList.remove('hidden');

        // Restore original position on blur/x-click
        searchInput.onblur = handleSearchBlur;
    };

    const handleSearchBlur = () => {
        const searchContainer = document.getElementById('search-container');
        searchContainer.classList.remove('search-focused');
        document.getElementById('search-results').classList.add('hidden');
    };

    const handleSearchInput = (value) => {
        const resultsEl = document.getElementById('search-results');
        if (value.length < 2) {
            resultsEl.innerHTML = '<p class="text-sm text-gray-500 p-2">Start typing to search...</p>';
            return;
        }
        // Mock Autocomplete Suggestion Logic
        const filtered = MOCK_STOCKS.filter(s => s.name.toLowerCase().includes(value.toLowerCase()) || s.id.includes(value.toLowerCase()));

        resultsEl.innerHTML = filtered.map(stock => {
            const isAdded = allWatchlists.find(w => w.id === currentWatchlistId)?.stocks?.includes(stock.id);
            const actionIcon = isAdded ? 'fa-check text-green-600' : 'fa-plus text-blue-600';
            const actionText = isAdded ? 'Added' : 'Add';

            return `
                <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-lg">
                    <div>
                        <p class="text-sm font-medium text-black">${stock.name}</p>
                        <p class="text-xs text-gray-500 uppercase">${stock.index}</p>
                    </div>
                    <button class="flex items-center space-x-1 p-1" onclick="toggleStockInWatchlist(event, '${stock.id}')">
                        <i class="fa-solid ${actionIcon} text-xs"></i>
                        <span class="text-xs text-gray-600">${actionText}</span>
                    </button>
                </div>
            `;
        }).join('');
    };

    const toggleStockInWatchlist = async (event, stockId) => {
        event.stopPropagation(); // Prevent search result click from triggering other things
        const currentList = allWatchlists.find(w => w.id === currentWatchlistId);
        if (!currentList) return;

        const stockRef = doc(db, getCollectionPath('watchlists'), currentList.id);
        const isAdded = currentList.stocks.includes(stockId);

        try {
            if (isAdded) {
                // Remove stock
                await updateDoc(stockRef, {
                    stocks: arrayRemove(stockId)
                });
            } else {
                // Add stock
                await updateDoc(stockRef, {
                    stocks: arrayUnion(stockId)
                });
            }
            // Re-run search input to update the '+' icon status
            handleSearchInput(document.getElementById('search-input').value);

        } catch (error) {
            console.error("Error toggling stock in watchlist:", error);
        }
    };

    // 5. Stock Detail Bottom Sheet
    let startY = 0;
    let currentSheetOffset = 0;

    const handleTouchStart = (e) => {
        startY = e.touches[0].clientY;
        document.getElementById('stock-detail-sheet').style.transition = 'none';
    };

    const handleTouchMove = (e) => {
        const diffY = e.touches[0].clientY - startY;
        // Only allow downward swipe for closing
        if (diffY > 0) {
            currentSheetOffset = diffY;
            document.getElementById('stock-detail-sheet').style.transform = `translateY(${diffY}px)`;
        }
    };

    const handleTouchEnd = () => {
        const sheet = document.getElementById('stock-detail-sheet');
        sheet.style.transition = 'transform 0.3s ease-out';
        const heightToClose = sheet.offsetHeight * 0.2; // 20% swipe to close

        if (currentSheetOffset > heightToClose) {
            closeStockDetailSheet();
        } else {
            sheet.style.transform = 'translateY(0%)';
        }
        currentSheetOffset = 0;
    };


    const handleStockClick = (stockId) => {
        const stock = MOCK_STOCKS.find(s => s.id === stockId);
        if (!stock) return;
        currentStock = stock;

        const sheet = document.getElementById('stock-detail-sheet');
        const overlay = document.getElementById('modal-overlay');

        // Populate header info
        const isPositive = stock.change >= 0;
        const changeColor = isPositive ? 'text-green-600' : 'text-red-600';
        const changeIcon = isPositive ? 'fa-caret-up' : 'fa-caret-down';
        const holdingText = stock.holdings > 0 ? `<span class="font-medium text-black">(${stock.holdings} held)</span>` : '';

        document.getElementById('sheet-header-info').innerHTML = `
            <div>
                <p class="text-lg font-bold text-black">${stock.name}</p>
                <p class="text-xs text-gray-500 uppercase mt-0.5">${stock.index} ${holdingText}</p>
            </div>
            <div class="text-right">
                <p class="text-lg font-bold text-black">${stock.price.toFixed(2)}</p>
                <p class="text-xs ${changeColor} mt-0.5">
                    <i class="fa-solid ${changeIcon} mr-0.5"></i> ${Math.abs(stock.change).toFixed(2)} (${Math.abs(stock.percent).toFixed(2)}%)
                </p>
            </div>
        `;

        // Render notes for this stock
        renderNotesList(stockId);

        // Open sheet
        sheet.classList.add('sheet-open');
        overlay.classList.remove('pointer-events-none', 'opacity-0');
        overlay.classList.add('pointer-events-auto', 'opacity-100');
        overlay.onclick = closeStockDetailSheet;
        document.body.style.overflow = 'hidden';
    };

    const closeStockDetailSheet = () => {
        const sheet = document.getElementById('stock-detail-sheet');
        const overlay = document.getElementById('modal-overlay');

        sheet.classList.remove('sheet-open');
        overlay.classList.remove('pointer-events-auto', 'opacity-100');
        overlay.classList.add('pointer-events-none', 'opacity-0');
        overlay.onclick = null;
        document.body.style.overflow = '';
        currentStock = null;
    };

    // 6. GTT Fullscreen Window
    const openGTTOrder = () => {
        if (!currentStock) return;
        closeStockDetailSheet();

        const gttScreen = document.getElementById('gtt-screen');
        const stock = currentStock;

        const isPositive = stock.change >= 0;
        const changeColor = isPositive ? 'text-green-600' : 'text-red-600';
        const changeIcon = isPositive ? 'fa-caret-up' : 'fa-caret-down';

        gttScreen.innerHTML = `
            <!-- GTT Header -->
            <div id="gtt-header" class="p-4 border-b border-gray-100 bg-white sticky top-0">
                <div class="flex items-center justify-between">
                    <i class="fa-solid fa-arrow-left text-lg text-black cursor-pointer" onclick="closeGTTOrder()"></i>
                    <h2 class="text-lg font-bold text-black">GTT</h2>
                </div>
                <div class="mt-3 flex justify-between items-end">
                    <div>
                        <p class="text-base font-semibold text-black">${stock.name}</p>
                        <p class="text-xs text-gray-500 uppercase">${stock.index} | LTP: ${stock.price.toFixed(2)}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm ${changeColor} font-semibold">
                            <i class="fa-solid ${changeIcon} mr-0.5"></i> ${Math.abs(stock.change).toFixed(2)} (${Math.abs(stock.percent).toFixed(2)}%)
                        </p>
                    </div>
                </div>
            </div>

            <!-- GTT Form Content -->
            <div id="gtt-form" class="p-4 space-y-5">
                <!-- Type: Buy/Sell -->
                <div>
                    <label class="block text-sm font-medium text-black mb-2">Type</label>
                    <div class="flex space-x-3 text-sm font-medium">
                        <button class="flex-1 py-2 border border-gray-300 rounded-lg bg-blue-100 text-blue-600">BUY</button>
                        <button class="flex-1 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">SELL</button>
                    </div>
                </div>

                <!-- Trigger Type: Single/OCO (One Cancels Other) -->
                <div>
                    <label class="block text-sm font-medium text-black mb-2">Trigger Type</label>
                    <div class="flex space-x-3 text-sm font-medium">
                        <button class="flex-1 py-2 border border-gray-300 rounded-lg bg-blue-100 text-blue-600">Single</button>
                        <button class="flex-1 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">OCO</button>
                    </div>
                </div>

                <!-- Stop Loss Section -->
                <div class="border border-gray-200 p-4 rounded-lg bg-gray-50">
                    <h3 class="text-base font-semibold text-black mb-3">STOP LOSS</h3>
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Trigger Price</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" value="${(stock.price * 0.95).toFixed(2)}" class="flex-1 border border-gray-300 rounded-md p-2 text-sm text-black focus:ring-0 focus:border-gray-500" id="sl-trigger-price">
                            <p class="text-xs text-gray-500 w-16 text-right">-5.00%</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Quantity</label>
                        <input type="number" value="1" class="w-full border border-gray-300 rounded-md p-2 text-sm text-black focus:ring-0 focus:border-gray-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Limit Price (CNC/MIS)</label>
                        <input type="number" value="${(stock.price * 0.94).toFixed(2)}" class="w-full border border-gray-300 rounded-md p-2 text-sm text-black focus:ring-0 focus:border-gray-500">
                    </div>
                </div>

                <!-- Target Section (Only visible for OCO, shown for context here) -->
                <div class="border border-gray-200 p-4 rounded-lg bg-gray-50">
                    <h3 class="text-base font-semibold text-black mb-3">TARGET</h3>
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Trigger Price</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" value="${(stock.price * 1.05).toFixed(2)}" class="flex-1 border border-gray-300 rounded-md p-2 text-sm text-black focus:ring-0 focus:border-gray-500" id="target-trigger-price">
                            <p class="text-xs text-gray-500 w-16 text-right">+5.00%</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Limit Price (CNC/MIS)</label>
                        <input type="number" value="${(stock.price * 1.06).toFixed(2)}" class="w-full border border-gray-300 rounded-md p-2 text-sm text-black focus:ring-0 focus:border-gray-500">
                    </div>
                </div>

                <!-- Footer Swipe Button -->
                <div class="fixed bottom-0 left-0 w-full max-w-[500px] mx-auto p-4 bg-white border-t border-gray-200">
                    <button id="gtt-swipe-btn" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg text-sm active:bg-blue-700">
                        <i class="fa-solid fa-arrow-right mr-2"></i> SWIPE TO CREATE GTT
                    </button>
                </div>

            </div>
        `;
        document.body.style.overflow = 'hidden';
        gttScreen.style.transform = 'translateX(0%)';
    };

    const closeGTTOrder = () => {
        document.getElementById('gtt-screen').style.transform = 'translateX(100%)';
        document.body.style.overflow = '';
        currentStock = null; // Clear current stock context
    };

    // 7. Add Notes Popup
    const openAddNotePopup = () => {
        if (!currentStock) return;
        document.getElementById('note-stock-name').textContent = currentStock.name;
        document.getElementById('note-content').value = '';
        const popup = document.getElementById('notes-popup');
        popup.classList.add('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-90', 'scale-100');
    };

    const closeAddNotePopup = () => {
        const popup = document.getElementById('notes-popup');
        popup.classList.remove('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-100', 'scale-90');
    };

    const saveNote = async () => {
        const content = document.getElementById('note-content').value.trim();
        if (!currentStock || !content) return;

        const stockId = currentStock.id;
        const newNote = { content: content, created: Date.now() };

        try {
            const notesRef = doc(db, getCollectionPath('notes'), 'user_notes');
            const newNotesArray = [...(stockNotes[stockId] || []), newNote];

            // Use setDoc with merge to update the map field within the document
            await setDoc(notesRef, {
                notes: {
                    ...stockNotes,
                    [stockId]: newNotesArray
                }
            }, { merge: true });

            closeAddNotePopup();
            renderNotesList(stockId); // Re-render the bottom sheet list
        } catch (error) {
            console.error("Error saving note:", error);
        }
    };

    // 8. Set Alert Popup
    const openSetAlertPopup = () => {
        if (!currentStock) return;
        document.getElementById('alert-current-price').textContent = currentStock.price.toFixed(2);
        document.getElementById('alert-price-input').value = (currentStock.price * 1.01).toFixed(2); // Suggest 1% up

        const popup = document.getElementById('alert-popup');
        popup.classList.add('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-90', 'scale-100');
    };

    const closeSetAlertPopup = () => {
        const popup = document.getElementById('alert-popup');
        popup.classList.remove('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-100', 'scale-90');
    };

    const saveAlert = async () => {
        const price = parseFloat(document.getElementById('alert-price-input').value);
        if (!currentStock || isNaN(price) || price <= 0) return;

        const stockId = currentStock.id;
        const newAlert = { price: price, created: Date.now(), stockName: currentStock.name };

        try {
            const alertsRef = doc(db, getCollectionPath('alerts'), 'user_alerts');
            const newAlertsArray = [...(stockAlerts[stockId] || []), newAlert];

            await setDoc(alertsRef, {
                alerts: {
                    ...stockAlerts,
                    [stockId]: newAlertsArray
                }
            }, { merge: true });

            checkActiveAlerts(true); // Check and potentially show notification
            closeSetAlertPopup();
        } catch (error) {
            console.error("Error saving alert:", error);
        }
    };

    // 9. Notification Handling (Alerts)
    const checkActiveAlerts = (justSet = false) => {
        const alertDot = document.getElementById('alert-dot');
        const alertMessageEl = document.getElementById('alert-message');
        const allAlerts = Object.values(stockAlerts).flat();

        if (allAlerts.length > 0) {
            // For a real app, this would check current price against the alert price
            // Here, we just check if any exist and use the latest one for the message
            alertDot.classList.remove('hidden');
            const latest = allAlerts[allAlerts.length - 1];

            if (justSet) {
                 alertMessageEl.innerHTML = `<span class="font-bold text-blue-600">Alert Set:</span> ${latest.stockName} @ ${latest.price.toFixed(2)}`;
            } else {
                 alertMessageEl.innerHTML = `${allAlerts.length} active alerts. Latest for ${latest.stockName}.`;
            }

        } else {
            alertDot.classList.add('hidden');
            alertMessageEl.textContent = 'No active alerts.';
        }
    };

    const openNotificationPopup = () => {
        const popup = document.getElementById('notification-popup');
        popup.classList.toggle('scale-0');
    };

    // 10. Watchlist Swiping Logic
    const watchlistContainer = document.getElementById('stock-list-container');
    let swipeStartX = 0;
    let swipeDiff = 0;

    watchlistContainer.addEventListener('touchstart', (e) => {
        swipeStartX = e.touches[0].clientX;
        watchlistContainer.style.scrollSnapType = 'none'; // Disable snap during swipe
    });

    watchlistContainer.addEventListener('touchmove', (e) => {
        // Prevent vertical scroll interference
        if (Math.abs(e.touches[0].clientY - e.touches[0].clientY) > 10) return;

        swipeDiff = e.touches[0].clientX - swipeStartX;
    });

    watchlistContainer.addEventListener('touchend', () => {
        const threshold = watchlistContainer.offsetWidth / 3; // Swipe more than 33%

        if (swipeDiff > threshold && currentWatchlistIndex > 0) {
            // Swipe right (go left to previous watchlist)
            currentWatchlistIndex--;
        } else if (swipeDiff < -threshold && currentWatchlistIndex < allWatchlists.length - 1) {
            // Swipe left (go right to next watchlist)
            currentWatchlistIndex++;
        }

        // Snap to the new (or current) position
        currentWatchlistId = allWatchlists[currentWatchlistIndex].id;
        renderWatchlistTabs();

        watchlistContainer.style.scrollLeft = currentWatchlistIndex * watchlistContainer.offsetWidth;
        watchlistContainer.style.scrollSnapType = 'x mandatory'; // Restore snap
        swipeDiff = 0;
    });

    // Initial render call (will be refined by Firebase listeners)
    // startMockListeners(); // Fallback removed, relying on window.onload now

</script>
